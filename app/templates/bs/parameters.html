{% extends "base_content.html" %}
{% block main_content %}
<section class="section">
  <div class="container-lg">
    <div class="wrapper__content-header">
      <div class="row">
        <div class="d-flex justify-content-between">
          <h2 class="display-6">{{ area_title[0] }} &ndash; {{ area_title[1] }}</h2>
          <button type="button" class="btn__outline-primary align-self-center" id="btnSelectArea"
            data-bs-toggle="offcanvas" data-bs-target="#sideMenu" aria-controls="sideMenu">Select area</button>
          <!-- <button type="button" class="btn__outline-primary" id="btnSelectArea" aria-controls="sideMenu">Select an
            area</button> -->
        </div>
      </div>
    </div>
    <div class="row">
      <div class="accordion" id="paramsCollapse">
        {% for file in files %}
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#params{{loop.index}}" aria-expanded="true" aria-controls="params{{loop.index}}"
              data-file-id="{{ file.id }}">
              {{ file.name }}
            </button>
          </h2>
          <div id="params{{loop.index}}" class="accordion-collapse collapse">
            <div class="accordion-body">
              <div class="params-detail" data-loaded="0">
                <div class="skeleton-block d-none">
                  <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  Loading...
                </div>
                <div class="params-content"></div>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</section>

{% endblock main_content %}

{% block scripts %}
<script src="{{ url_for('static', filename='scripts.js') }}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const accordionButtons = document.querySelectorAll('.accordion-button');
    const selectAreaButton = document.getElementById('btnSelectArea');

    accordionButtons.forEach(button => {
      button.addEventListener('click', async function () {
        const fileId = button.dataset.fileId;
        const targetId = button.getAttribute('data-bs-target');
        const accordionBody = document.querySelector(targetId + ' .params-detail');
        const skeleton = accordionBody.querySelector('.skeleton-block');
        const contentDiv = accordionBody.querySelector('.params-content');

        // Only load content if not already loaded
        if (accordionBody.dataset.loaded === '0') {
          // Show loading skeleton
          skeleton.classList.remove('d-none');

          try {
            accordionBody.dataset.loaded = '1';

            // Call API to get file details
            const endpoint = "{{ url_for('programs.parameter_details', college_id=college.tag, program_id=data.tag, drive_id='PLACEHOLDER')}}".replace('PLACEHOLDER', fileId);
            const data = await getApiData(endpoint);

            // Hide skeleton
            skeleton.classList.add('d-none');

            // Check if data.files is empty
            if (!data.files || data.files.length === 0) {
              contentDiv.innerHTML = '<div class="alert alert-warning">No PDF document(s) found.</div>';
              return;
            }
            // Process and display the data
            data['files'].forEach(files => {
              if (isGoogleDriveFolder(files.mimeType)) {
                const headerMarkup = markUpParamsContent(files, true, true);
                contentDiv.insertAdjacentHTML('beforeend', headerMarkup);
              } else {
                const markup = markUpParamsContent(files, false, true);
                contentDiv.insertAdjacentHTML('beforeend', markup);
              }

              if (files['files']) {
                files['files'].forEach(file => {
                  const markup = markUpParamsContent(file, false);
                  contentDiv.insertAdjacentHTML('beforeend', markup);
                });
              }
            });

          } catch (error) {
            console.error('Error fetching file data:', error);
            accordionBody.dataset.loaded = '0';
            skeleton.classList.add('d-none');
            contentDiv.innerHTML = '<div class="alert alert-danger">Error loading content. Please try reloading the page.</div>';
          }
        }
      });
    });

    selectAreaButton.addEventListener('click', async function () {
      try {
        // Get the offcanvas body element
        const offcanvasBody = document.querySelector('#sideMenu .offcanvas-body');

        // Load content if not loaded
        if (offcanvasBody.dataset.loaded === '1') {
          return;
        }
        // Show loading state
        offcanvasBody.innerHTML = `
      <div class="d-flex justify-content-center">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    `;

        // Fetch areas data from the program_areas route
        const endpoint = "{{ url_for('programs.program_areas', college_id=college.tag, program_id=data.tag) }}";
        const response = await fetch(endpoint, {
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        // Clear loading state and populate with areas
        offcanvasBody.innerHTML = '';

        // Mark as loaded
        offcanvasBody.dataset.loaded = '1';

        if (data.files && data.files.length > 0) {
          const areasHtml = data.files.map(file => `
         <div class="mb-2">
      <a href="/colleges/{{ college.tag }}/{{ data.tag }}/${file.slug}/${file.id}"
         class="text-decoration-none d-block p-2 border rounded area-link">
        <i class="bi bi-folder me-2"></i>
        ${file.name}
      </a>
    </div>
      `).join('');

          offcanvasBody.innerHTML = `
        <h6 class="mb-3">Select an Area:</h6>
        ${areasHtml}
      `;
        } else {
          offcanvasBody.innerHTML = '<div class="alert alert-info">No areas found.</div>';
        }

      } catch (error) {
        console.error('Error fetching areas:', error);
        const offcanvasBody = document.querySelector('#sideMenu .offcanvas-body');
        // Reset loaded state on error so user can retry
        offcanvasBody.dataset.loaded = '0';
        offcanvasBody.innerHTML = '<div class="alert alert-danger">Error loading areas. Please try again.</div>';
      }

    });
  });

  function markUpParamsContent(file, isFolder = false, top_level = false) {
    if (isFolder) {
      return `<div class="fw-bold mb-1 mt-2 px-3"><i class="bi bi-arrow-right-short text-secondary"></i>${file.name}</div>`;
    }
    if (top_level) {
      return `<div class="mb-1 px-3"><a href="${file.webViewLink}" target="_blank" class="text-decoration-none file__link">
        <i class="bi bi-file-earmark"></i>&nbsp;${file.name}</a></div>`;
    }
    return `<div class="mb-1 px-5"><a href="${file.webViewLink}" target="_blank" class="text-decoration-none file__link">
      <i class="bi bi-file-earmark"></i>&nbsp;${file.name}</span></a></div>`;
  }

</script>
{% endblock scripts %}